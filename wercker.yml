box: ruby
build:
  steps:
    - add-ssh-key:
        keyname: DEPLOY_SSH_KEY
    - add-to-known_hosts:
        hostname: github.com
    - script:
        name: prepare building
        code: |
          apt-get update
          apt-get -y install git
          git clone https://github.com/linyows/hugo-theme-flag themes/flag
          rm -rf themes/flag/.git
    - arjen/hugo-build:
        version: '0.14'
        theme: flag
    - script:
        name: commit built html to deploy branch
        code: |
          git checkout -b deploy
          ls | grep -v public | xargs rm -rf
          mv public/* ./ ; rm -rf public
          git config user.email 'pleasemailus@wercker.com' ; git config user.name 'werckerbot'
          git add .
          git commit -m "deploy from $WERCKER_STARTED_BY"
          git push -f origin deploy
deploy:
  steps:
    - s3sync:
        key-id: $S3_KEY
        key-secret: $S3_SECRET
        bucket-url: $S3_BUCKET
        source-dir: $S3_SOURCE
        opts: '--region=ap-northeast-1 --exclude=".git*" --acl-public'
