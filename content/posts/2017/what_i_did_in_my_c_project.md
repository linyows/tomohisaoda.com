+++
date = "2017-03-01T10:20:20+09:00"
draft = true
title = "Cのプロダクトを作るためにやったこと"

+++

今年に入って Octopass というプロダクトを公開しました。
それは、Linuxのユーザや権限をGithubのTeamと連携して運用を楽にするというツールでした。

OSS界隈で有名な@matumotoryさんやそのほかのtweetによって、はてぶの数やコメントを見る限り、
ある程度必要そうな人の目に触れたのではないかと思っています。

また、「すごく便利」「ぜひ導入したい」というフィードバックはとてもモチベーションにつながっています。

さて、この Octopass は、Linuxユーザ名前解決をするためにの glibc の libnssモジュールをCで実装しています。
cgoやその他の言語でShared Objectを吐き出しても良かったのですが、それだと技術的挑戦が足りないとして、
触れてこなかったCに挑戦してみました。

Clang Format
------------

まず、自分が作るのがlibnssのモジュールなので既存のものをgithubで検索してひたすら読んでみました。
最初に気になったのが、coding styleがバラバラなこと。

これは @matumotory さんに `clang-format` という整形ツールがあるよという情報を得たので、
早速適当にformatを定義し、vimと連携することで保存時にきれいに整形されるという感じになりました。
また、もし、仮に PullRequestをもらった時のためにも CIで formatのdiffをチェックするようにもしました。

Criterion
---------

次に、Unit Test。色々Cのプロジェクト見ていると、main書いて最低限のテストを書いてたり、
自前でassertion作ってたりといて結構カオスです。
何かしらtest frameworkはないかなと調べると良さそうなものがいくつかあります。

- CUnit
- googletest
- Unity
- Criterion

真面目に比較する時間はなかったので
exampleが多いものと出力が分かりやすいものをとりあえず使ってみようとCriterionを使い始めました。
Criterion使うと結構便利で `assertion` もいろんなものがあって今の時点では困ることはありませんでした。

Makefile
--------

次に、テストを頻繁に実行しだすとコンパイルしてテスト実行というのが面倒になってきます。
そうするとGNU Makeの出番で、ビルドやビルドに必要な依存ライブラリ等をセットアップ
することを定義していきます。
そして、Makeの自己文書化という裏技を見つけ導入していきます。そうやって、どんどん完成に近づいてきました。

Packaging
---------

プロダクトが完成すると、使いやすくするために、パッケージにしたくなってきます。
そのパッケージ化を手でやってたら面倒なので docker-composeで、RPMやDEBのパッケー
ジがさっと作成されてそのアーカイブがGithub Rereasesにアップロード出来たら便利と
いうことで、これもまたMakefileでチマチマやりました。
そうすることで、新しいバージョンを公開することがものすごく手軽になりました。

Integration Test
----------------

ユニットテストしか書いてなかったので、いざ作ったパッケージをインストールして試し
たら `Segmentaion fault` とか出たりして統合テストが出来てなかったことに気づきます。
ただし、今回の場合検証項目が少ないため、さっとbashで書いてしまいました。
もしかしたら、Criterionで出来たかもしれません。

Conclution
----------

Cのプロダクトを作る際にやったことをまとめると以下です。

- スタイルフォーマット > Clang Format
- Unit Test > Criterion
- 色々自動化 > Makefile
- パッケージ作成 > Dokcer Compose と ghr
- Integration Test > bashで書いた

これらを抽象化すると、Cスターターみたいなものが出来るなと思いつつ、
もうしばらくは書くことないかなと思いました。
